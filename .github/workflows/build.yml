name: Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Get current version
      id: get_version
      run: |
        VERSION_NAME=$(grep -oP 'versionName = "\K[^"]+' app/build.gradle.kts)
        VERSION_CODE=$(grep -oP 'versionCode = \K[0-9]+' app/build.gradle.kts)
        echo "current_version=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "current_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "Current version: $VERSION_NAME ($VERSION_CODE)"

    - name: Bump patch version
      id: bump_version
      run: |
        VERSION_NAME="${{ steps.get_version.outputs.current_version }}"
        VERSION_CODE="${{ steps.get_version.outputs.current_code }}"
        
        # Parse version components
        IFS='.' read -ra VERSION_PARTS <<< "$VERSION_NAME"
        MAJOR="${VERSION_PARTS[0]}"
        MINOR="${VERSION_PARTS[1]}"
        PATCH="${VERSION_PARTS[2]}"
        
        # Increment patch version
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
        NEW_CODE=$((VERSION_CODE + 1))
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "new_code=$NEW_CODE" >> $GITHUB_OUTPUT
        echo "New version: $NEW_VERSION ($NEW_CODE)"

    - name: Update version in build.gradle.kts
      run: |
        sed -i 's/versionCode = ${{ steps.get_version.outputs.current_code }}/versionCode = ${{ steps.bump_version.outputs.new_code }}/' app/build.gradle.kts
        sed -i 's/versionName = "${{ steps.get_version.outputs.current_version }}"/versionName = "${{ steps.bump_version.outputs.new_version }}"/' app/build.gradle.kts

    - name: Decode keystore
      run: |
        base64 -d keystore/breeze-release.b64 > keystore/breeze-release.jks
      
    - name: Build Release APK
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      run: ./gradlew assembleRelease -PKEYSTORE_PASSWORD=$KEYSTORE_PASSWORD

    - name: Rename APK
      run: |
        mv app/build/outputs/apk/release/app-release.apk app/build/outputs/apk/release/breeze-v${{ steps.bump_version.outputs.new_version }}.apk

    - name: Commit version bump
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add app/build.gradle.kts
        git diff --staged --quiet || git commit -m "chore: bump version to ${{ steps.bump_version.outputs.new_version }}"
        git push

    - name: Create and push tag
      run: |
        TAG_NAME="v${{ steps.bump_version.outputs.new_version }}"
        git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
        git push origin "$TAG_NAME"

    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: breeze-v${{ steps.bump_version.outputs.new_version }}
        path: app/build/outputs/apk/release/breeze-v${{ steps.bump_version.outputs.new_version }}.apk

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.bump_version.outputs.new_version }}
        name: Breeze v${{ steps.bump_version.outputs.new_version }}
        body: |
          ## Breeze v${{ steps.bump_version.outputs.new_version }}
          
          자동 빌드된 APK 파일입니다.
          
          ### 설치 방법
          1. 아래 APK 파일을 다운로드하세요
          2. 안드로이드 기기에서 설치하세요
          
          ### 변경사항
          최신 main 브랜치 기준 빌드
        files: app/build/outputs/apk/release/breeze-v${{ steps.bump_version.outputs.new_version }}.apk
        draft: false
        prerelease: false
